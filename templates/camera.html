<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Camera Upload</title>
<style>
  body {
    font-family: system-ui, Roboto, Arial;
    background: #f1f3f4;
    margin: 0;
    padding: 20px;
  }
  .card {
    background: white;
    padding: 20px;
    border-radius: 14px;
    max-width: 700px;
    margin: auto;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  }
  h2 { margin-top: 0; }
  video {
    width: 100%;
    border-radius: 10px;
    border: 1px solid #ddd;
    background: #000;
  }
  .controls {
    margin-top: 15px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  label, button {
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid #ddd;
    background: white;
  }
  button {
    background: #1976d2;
    color: white;
    border: none;
    cursor: pointer;
  }
  button:disabled { background: #999; }
</style>
</head>

<body>
<div class="card">
  <h2>Camera â†’ Server</h2>
  <video id="video" autoplay playsinline muted></video>

  <div class="controls">
    <label>FPS <input id="fps" type="number" value="5" min="1" max="30"></label>
    <label>Quality <input id="quality" type="number" value="0.7" step="0.1" min="0.1" max="1"></label>
    <button id="start">Start</button>
    <button id="stop" disabled>Stop</button>
  </div>

  <p>Viewer: <code id="viewerUrl"></code></p>
</div>

<script>
(async () => {
  const video = document.getElementById('video');
  const startBtn = document.getElementById('start');
  const stopBtn = document.getElementById('stop');
  const fpsInput = document.getElementById('fps');
  const qualityInput = document.getElementById('quality');
  const viewerUrl = document.getElementById('viewerUrl');

  viewerUrl.textContent = location.origin + '/viewer';

  let stream;
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
  } catch (err) {
    alert("Camera error: " + err.message);
    return;
  }

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  let running = false;
  let handle = null;

  //new
  function sendFrame(blob) {
    const form = new FormData();
    form.append("frame", blob);
    form.append("fps", fpsInput.value);
    form.append("quality", qualityInput.value);
    form.append("width", video.videoWidth);
    form.append("height", video.videoHeight);
  
    fetch("/upload", { method: "POST", body: form });
  }
  //end
  
  function capture() {
    if (!video.videoWidth) return;
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    const q = parseFloat(qualityInput.value);
    canvas.toBlob((blob) => blob && sendFrame(blob), 'image/jpeg', q);
  }

  startBtn.onclick = () => {
    if (running) return;
    running = true;
    handle = setInterval(capture, 1000 / fpsInput.value);
    startBtn.disabled = true;
    stopBtn.disabled = false;
  };

  stopBtn.onclick = () => {
    running = false;
    clearInterval(handle);
    startBtn.disabled = false;
    stopBtn.disabled = true;
  };
})();
</script>
</body>
</html>