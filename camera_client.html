<!doctype html>
<html>
<head><meta charset="utf-8"><title>Camera Client</title></head>
<body>
  <h2>Camera Client</h2>
  <video id="video" autoplay playsinline muted style="max-width:100%"></video>
  <div>
    <label>FPS: <input id="fps" value="5" type="number" min="1" max="30"></label>
    <label>Quality: <input id="quality" value="0.7" step="0.1" min="0.1" max="1"></label>
    <button id="start">Start</button>
    <button id="stop" disabled>Stop</button>
  </div>
  <p>Viewer: <code id="viewerUrl"></code></p>

<script>
(async () => {
  const video = document.getElementById('video');
  const startBtn = document.getElementById('start');
  const stopBtn = document.getElementById('stop');
  const fpsInput = document.getElementById('fps');
  const qualityInput = document.getElementById('quality');
  const viewerUrlEl = document.getElementById('viewerUrl');

  viewerUrlEl.textContent = location.origin + '/viewer';

  let stream;
  try {
    stream = await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject = stream;
  } catch(e) {
    alert('Camera error: ' + e.message);
    return;
  }

  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  let intervalHandle = null;

  function startSending(){
    const fps = Math.max(1, parseInt(fpsInput.value) || 5);
    const interval = 1000 / fps;
    intervalHandle = setInterval(() => {
      if (!video.videoWidth) return;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      canvas.toBlob((blob) => {
        if (!blob) return;
        fetch('/upload', {
          method: 'POST',
          headers: {'Content-Type': 'image/jpeg'},
          body: blob
        }).catch(e => console.warn('Upload fail', e));
      }, 'image/jpeg', parseFloat(qualityInput.value) || 0.7);
    }, interval);
    startBtn.disabled = true;
    stopBtn.disabled = false;
  }

  function stopSending(){
    if (intervalHandle) { clearInterval(intervalHandle); intervalHandle = null; }
    startBtn.disabled = false;
    stopBtn.disabled = true;
  }

  startBtn.onclick = startSending;
  stopBtn.onclick = stopSending;

})();
</script>
</body>
</html>